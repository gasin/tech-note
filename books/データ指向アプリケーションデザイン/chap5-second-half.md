## データ指向アプリケーションデザイン 5章後半

### 概要
DB におけるレプリケーションの仕組み後半

マルチリーダーレプリケーションとリーダーレスレプリケーション

### 気になったことメモ・自分用まとめ
- マルチリーダーレプリケーション
  - リーダー間での衝突を考える必要まで出てくるため、避けるべき構成とのこと
    - 衝突は last write wins などで解決するが、欠損も大きい
    - リーダーが多くなると、ネットワークの時のようにトポロジーも考える必要がある
  - オフラインでの運用も必要な場合には考える必要があるらしい
  - 例としてコラボレーティブな編集が挙げられている
    - 確かに普段何気なく使ってるが、実装しろと言われたら大変そう
- 操作変換
  - コラボレーティブ編集の実装法として紹介されている
  - [このブログ](https://qiita.com/phigasui/items/d68bbc7c8023ab11af92)がわかりやすい
    - 紹介されている[visualizer](https://operational-transformation.github.io/index.html)を触ると理解しやすい
    - 各々が行った変更について、順序関係なく同じ結果になるように変換する
  - ここでは2ユーザの例が挙げられていたが、一般にはnユーザについてこれを行う必要がある？（そうなのだとしたらかなり複雑そう）
- Dynamo
  - リーダーレスレプリケーションの例として挙げられている
  - ググるとビジュアルプログラミングツールがヒットするが、これじゃない（これも知らなかった）
    - [これも面白そうではある](https://primer.dynamobim.org/ja/01_Introduction/1-1_what_is_visual_programming.html)
  - また、適当にググると DynamoDB という Amazon の NoSQL サービスがヒットするが、これも別物らしい
- リーダーレスレプリケーション
  - リーダーがいないので基本的に書き込みも読み込みも全ノードに向ける
    - 一部で障害が起きても問題ない
      - 障害が起きていたノードは読み取り時もしくは常時、各ノードは書き込みが遅れていないかチェックする
    - クラオムという用語があり、書き込みと読み取りが少なくともどれぐらいのノードで成功していれば処理が続行できるかを扱う
  - マルチリーダーレプリケーションと同様に、衝突した並列書き込みについては LWW などを用いて解決する
  - 並行して書き込まれた値（sibling）はそれぞれのノードがマージする必要がある
    - CRDT
        - [わかりやすいブログ](https://qiita.com/everpeace/items/bb73ec64d3e682279d26)
        - こちらは可換な構造を入れられたら sibling をマージできるよねということをしてそう
        - したい操作にどう構造を入れるかという話になるんだと思う（多分）
          - 上のほうで書いた操作変換はこれの一種な気がする（大嘘かも）
- Version Vector
  - ググると[かなりよさげな記事](https://hazm.at/mox/distributed-system/algorithm/consistency/version-vector/index.html)が hit したが、今読む元気がないので今度読む...
  - 文中に Merkle Tree という見たことあるようなの単語が見えたのでこっちを調べた
    - [わかりやすいブログ](https://brilliant.org/wiki/merkle-tree/)
    - peer-to-peer の分散システム（まさにリーダレスレプリケーション）で使われる
      - ググるとブロックチェーン（全てを忘れた）とかヒットする
    - 各ノードがハッシュを管理していて、セグメント木と似たようなノリで、根から走査して diff が発生しているブロックを効率よく特定するデータ構造
      - 暗号的に安全がどうこうの話は理解してない
      - Second Preimage Attack を調べたら、https://crypto.stackexchange.com/a/2107 がわかりやすかった(ハッシュ関数を葉とその他で変えたり、葉を区別したりと色々対策は有りそうだった)
