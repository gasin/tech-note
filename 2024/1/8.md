## データ指向アプリケーションデザイン 8章

### 概要
現実の分散システムは厄介な問題が色々あってつらいよという紹介

信頼性の低いネットワーク、信頼性の低いクロック、悪意のあるノードなど

### 個人的まとめ・気になったことメモ
- 分散システムの辛い点
  - 単一システムと異なり、部分的に壊れることを考慮する必要がある
    - 単一システムなら一部が壊れたらエラーにすればよい
    - 分散システムは、その目的からしてそのようなことはできない
  - 障害については、いつどのタイミングで起きるが不明で、そもそも障害が起きているかどうか外から知ることすら容易ではない
  - 完全に対処することは不可能だが、信頼性の高いシステムを作る必要がある
- ネットワーク
  - シェアードナッシングシステムだと基本的にネットワークを介して通信が行われる
  - 通信に失敗したということをまずは検知する必要がある
    - timeout を設定して、それを超えたら失敗したと判定する
    - timeout をいくつにするかは悩ましい問題
      - 長いほうが信頼性は高まるが、パフォーマンスが落ちる
      - ネットワークにおけるキューイングによって、結果が返ってくる時間にばらつきがある
        - ネットワークの輻輳、フロー制御などにより
        - 同期ネットワークだとこの問題は生じないが、通信帯域を効率よく使用するために非同期ネットワークを用いるのが主流
- クロック
  - ノードに搭載されているクロックは高性能ではあるものの、ノードによって微妙にずれているため、分散システムにおいては LWW の結果が異なるなどの問題が生じうる
    - Network Time Protocol サーバと同期をとることで緩和はできるが、完全に解決するものではない
    - Google Cloud Spanner では TrueTime と呼ばれる、信頼区間を管理してそれをトランザクションの順序付けに用いるという技術が導入されている
      - Cloud Spanner を調べたときにこれは言及されていたが、解像度が少し上がった
- プロセスの一時停止
  - ノードで時間を扱っている際には、任意の箇所で実行時間が想定よりも長くなりうることを想定する必要がある
  - ガベージコレクション、スラッシング、SIGSTOP など、コード的には一瞬で終わるはずの箇所に時間がかかることがある
    - GC はその処理を計画された処理として扱うことで想定外の遅延を緩和することができる
    - スラッシングはサーバマシンでは禁止されがち
- フェンシングトークン
  - あるクライアントが stop-the-world GC などによりリース（ロック）の期限が切れた際に、そのクライアントの処理を拒否するためのトークン
  - 単調増加する数値を用いることで順序を判断できる
- ビザンチン障害
  - ノードが悪意のあるデータの書き換えを行うこと
    - 航空宇宙だと放射線の影響でデータの書き換えが起こるのでビザンチン障害を考慮する必要があるという例が面白い
    - 本文中にもあるが、この辺りをググるとブロックチェーンがかなりヒットする
      - 昔に1冊本を読んだが何も覚えてない...
  - ビザンチン耐性をシステムに持たせるのは複雑な上に、多くのシステムではそこまで考慮する必要はない
  - 設定ミスなどによる障害は起きうるので、データが正しいかチェックを各所に入れるのは有効な対策
  - PBFT（[わかりやすい記事](https://hazm.at/mox/distributed-system/algorithm/transaction/pbft/index.html)）というアルゴリズムがヒットするが、正直これだけだと何をしているのかよくわからない（当たり前のことをしているようにしか見えない）
    - 合意アルゴリズムは次の章なので、そこで基本を学んでから読む
- システムモデル
  - 分散システムを理論的に議論するために抽象化したもの
    - 現実がその通りに動作するというわけではないが、有用なもの
  - 問題設定はたくさんある
    - 同期モデル・部分同期モデル・非同期モデル
    - クラッシュストップフォールト・クラッシュリカバリフォールト・ビザンチン障害
    - 安全性・ライブ性
    - ...
    - 現実で考慮するべき問題設定は山のようにあると思うので、学術（理論）界隈でどのぐらいまでモデルに組み込むのか見たいな話は厄介そう（みんなが好き勝手に拡張していった結果、複雑度ばかり増して、まとまりがなくなるような気もする）
  - この辺りの計算モデルとかの話に興味はあるが、大学の講義で何もわからんとなるのを経験したので敬遠しがち
